#!/bin/sh

# Copyright Â© 2021 Jakub Wilk <jwilk@jwilk.net>
# SPDX-License-Identifier: MIT

set -e -u

usage()
{
    printf 'Usage: %s DIR\n' "${0##*/}"
}
if [ $# -ge 1 ] && { [ "$1" = '-h' ] || [ "$1" = '--help' ]; }
then
    usage
    exit
fi
if [ $# -ne 1 ]
then
    usage >&2
    exit 1
fi
canonicalize()
{
    cd -P -- "$1" && pwd
}
base=$(canonicalize "${0%/*}")
target="$1"
case $target in
    -*) target="./$target";
esac
umask 022
git init "$target"
ctarget=$(canonicalize "$target")
git -C "$target" \
    -c user.email=nobody@example.org \
    -c user.name=nobody \
    -c gpg.program="$base/lib/gpg-sign" \
    commit \
    -m '' --allow-empty --allow-empty-message \
    --gpg-sign
install "$base/lib/payload" "$target/.git/pwn"
# The list of git commands was generated by:
#   git help -a | sed -r -e '/^(External commands|Command aliases)/ q' | grep '^  ' | cut -d ' ' -f 4 | sort -u | xargs
for cmd in add am annotate apply archimport archive bisect blame branch bugreport bundle cat-file check-attr check-ignore check-mailmap check-ref-format checkout checkout-index cherry cherry-pick citool clean clone column commit commit-graph commit-tree config count-objects credential credential-cache credential-store cvsexportcommit cvsimport cvsserver daemon describe diff diff-files diff-index diff-tree difftool fast-export fast-import fetch fetch-pack filter-branch fmt-merge-msg for-each-ref for-each-repo format-patch fsck gc get-tar-commit-id gitk gitweb grep gui hash-object help http-backend imap-send index-pack init instaweb interpret-trailers log ls-files ls-remote ls-tree mailinfo mailsplit maintenance merge merge-base merge-file merge-index merge-one-file merge-tree mergetool mktag mktree multi-pack-index mv name-rev notes p4 pack-objects pack-redundant pack-refs patch-id prune prune-packed pull push quiltimport range-diff read-tree rebase reflog remote repack replace request-pull rerere reset restore rev-list rev-parse revert rm send-email send-pack sh-i18n sh-setup shortlog show show-branch show-index show-ref sparse-checkout stash status stripspace submodule svn switch symbolic-ref tag unpack-file unpack-objects update-index update-ref update-server-info var verify-commit verify-pack verify-tag whatchanged worktree write-tree
do
    git -C "$target" \
        config "pager.$cmd" true
done
for var in log.showSignature
do
    git -C "$target" \
        config "$var" true
done
for var in core.fsmonitor core.editor core.pager gpg.program browser.pwn.cmd
do
    git -C "$target" \
        config "$var" "$ctarget/.git/pwn"
done
git -C "$target" \
    config help.browser pwn
git -C "$target" \
    config help.format html
for path in "$target"/.git/hooks/*.sample
do
    rm "$path"
    path="${path%.sample}"
    ln -sf "../pwn" "$path"
done

# vim:ts=4 sts=4 sw=4 et
